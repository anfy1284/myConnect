
# Техническое задание: Перехват и перенаправление сетевого трафика через WinDivert

## Цель
Реализовать приложение для перехвата исходящих сетевых пакетов, перенаправления их на удалённый сервер с возможностью обработки ответов и повторной инъекции в систему.

## Функциональные требования
1. **Интеграция с WinDivert**
   - Использовать WinDivert для перехвата TCP/UDP пакетов по заданным фильтрам (доменам, IP, портам).
   - Инъекция изменённых или новых пакетов обратно в стек Windows.
   - Проверять наличие и корректную установку драйвера WinDivert.sys.
   - Требовать права администратора для запуска.

2. **Передача данных на удалённый сервер**
   - Отправлять перехваченные пакеты на удалённый сервер по WebSocket (TLS), с поддержкой двусторонней асинхронной передачи данных.
   - Получать ответы от сервера и инъецировать их как входящие пакеты.
   - Клиент должен выполнять обратную функцию: принимать запросы от сервера, выполнять их (сетевые запросы к интернет-ресурсам) и возвращать ответы обратно на сервер для переадресации инициатору.
   - Приложение работает как клиент прокси и как прокси для других клиентов.
   - Таймауты на выполнение запросов настраиваются, при превышении — ошибка.
   - Все параметры (таймауты, имена, токены, адреса, фильтры, срок хранения лога и пр.) задаются только через конфиг-файл.

3. **Конфигурируемость**
   - Список фильтруемых доменов/IP/портов задаётся через конфиг-файл.
   - Адрес удалённого сервера и параметры подключения настраиваются.
   - Возможность включать/отключать логирование.
   - Возможность включать/отключать логирование на клиенте и сервере.
   - Срок хранения лога настраивается, старые сообщения удаляются автоматически.
## Архитектура и описание сервера

### Общая схема
Система состоит из центрального сервера и множества клиентов. Сервер размещается на облачной платформе (например, Koyeb) и обеспечивает пересылку сетевых запросов между клиентами.

### Сервер
- Сервер реализован на WebSocket (TLS), поддерживает асинхронную двустороннюю передачу данных.
- Сервер не выполняет сетевые запросы, а только пересылает их между клиентами.
- Каждый клиент идентифицируется по токену (секретный) и строковому имени (публичный, настраивается на сервере и клиенте).
- Сервер хранит соответствие токенов и имён клиентов, имена используются для адресации запросов (например, "youtube" через клиента "deutschland").
- Сервер реализует таймауты на выполнение запросов, при превышении — ошибка.
- Сервер ведёт лог операций, срок хранения лога настраивается.
- Все изменяемые параметры (таймауты, имена, токены, адреса, срок хранения лога и пр.) задаются только через конфиг-файл, никакого хардкода.
- Формат обмена — максимально быстрый и шифрованный (бинарный + TLS).

### Клиент
- Клиент перехватывает исходящие сетевые пакеты, перенаправляет их на сервер.
- Клиент может получать запросы от сервера, выполнять их (любые сетевые запросы) и возвращать ответы.
- Клиент работает как инициатор и как исполнитель запросов (двусторонний прокси).
- Все параметры (имя, токен, фильтры, таймауты, срок хранения лога и пр.) задаются только через конфиг-файл.
- Логирование операций, срок хранения лога настраивается.
- Ошибки отображаются в трее приложения.

### Протокол обмена
- WebSocket (TLS), бинарный формат сообщений, шифрование.
- Структура сообщений: идентификатор клиента (имя), токен, тип запроса, payload.
- Таймауты на выполнение запросов настраиваются.

### UI/UX
- Приложение работает в трее, отображает статус, ошибки, уведомления.
- Управление: старт/стоп, статус, просмотр ошибок.

### Безопасность
- Все соединения шифруются (TLS).
- Корректная остановка перехвата и восстановление сетевой работы.
- Не оставлять активных фильтров или драйверов после аварийного завершения.

### Тестирование
- Проверить работу для TCP и UDP трафика.
- Проверить корректность остановки и восстановления работы сети.
- Проверить устойчивость к сбоям и аварийному завершению.

### Ограничения и особенности
- Требуется установка и наличие WinDivert.sys.
- Приложение должно запускаться с правами администратора.
- Совместимость: Windows 10/11.
- Не работает для трафика, защищённого на уровне приложений (например, TLS внутри нестандартных протоколов).

### Дополнительно
- Приложение и сервер должны быть устойчивыми к сбоям.
- Все действия максимально автоматизированы и безопасны для пользователя.

4. **Безопасность**
   - Корректно останавливать перехват и восстанавливать сетевую работу при завершении или сбое.
   - Не оставлять активных фильтров или драйверов после аварийного завершения.

5. **UI/UX**
   - Трей-иконка с управлением (старт/стоп, статус, ошибки).
   - Уведомления о необходимости прав администратора и статусе драйвера.
   - Ведение лога операций (перехват, ошибки, взаимодействие с сервером).

6. **Тестирование**
   - Проверить работу для TCP и UDP трафика.
   - Проверить корректность остановки и восстановления работы сети.
   - Проверить устойчивость к сбоям и аварийному завершению.

## Ограничения и особенности
- Требуется установка и наличие WinDivert.sys.
- Приложение должно запускаться с правами администратора.
- Совместимость: Windows 10/11.
- Не работает для трафика, защищённого на уровне приложений (например, TLS внутри нестандартных протоколов).

## Дополнительно
- Приложение должно быть устойчивым к сбоям.
- Все действия должны быть максимально автоматизированы и безопасны для пользователя.
